name: Firebase Test Lab UI Test

on:
  workflow_call:
    inputs:
      apk_path:
        description: 'Path to the app APK'
        required: true
        type: string
      test_apk_path:
        description: 'Path to the test APK'
        required: true
        type: string
    secrets:
      GCP_SA_KEY:
        required: true
      GCP_PROJECT_ID:
        required: true

jobs:
  run-ui-tests:
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - name: Download App APK
        uses: actions/download-artifact@v4
        with:
          name: ${{ inputs.apk_path }}
          path: app/build/outputs/apk/debug

      - name: Download Test APK
        uses: actions/download-artifact@v4
        with:
          name: ${{ inputs.test_apk_path }}
          path: app/build/outputs/apk/androidTest/debug

      # Authenticate to Google Cloud
      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Set up gcloud
        uses: google-github-actions/setup-gcloud@v3
        with:
          project_id: ${{ secrets.GCP_PROJECT_ID }}

      # Run tests on real devices
      - name: Run UI tests on Firebase Test Lab
        run: |
          gcloud firebase test android run \
            --type instrumentation \
            --app app/build/outputs/apk/debug/app-debug.apk \
            --test app/build/outputs/apk/androidTest/debug/app-debug-androidTest.apk \
            --device model=cheetah,version=33,locale=en,orientation=portrait \
            --timeout 15m \
            --results-bucket=gs://warbler-weather-test-results \
            --test-targets "class com.warbler.tests.usecases.DemoTest"
