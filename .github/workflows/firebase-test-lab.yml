name: Android UI Tests (Firebase Test Lab)

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  firebase-test-lab:
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      # 1. Checkout code
      - name: Checkout repository
        uses: actions/checkout@v4

      # 2. Set up JDK (adjust version if needed)
      - name: Set up JDK
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 21

      # 3. Cache Gradle (important for speed)
      - name: Cache Gradle
        uses: actions/cache@v4
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
          key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
          restore-keys: |
            ${{ runner.os }}-gradle-

      # 4. Build APKs (app + androidTest)
      - name: Build app and test APKs
        run: |
          ./gradlew assembleDebug assembleDebugAndroidTest

      # 5. Authenticate to Google Cloud
      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      # 6. Set up gcloud CLI
      - name: Set up gcloud
        uses: google-github-actions/setup-gcloud@v2
        with:
          project_id: ${{ secrets.GCP_PROJECT_ID }}

      # 7. Run Firebase Test Lab instrumentation tests
      - name: Run tests on Firebase Test Lab
        run: |
          gcloud firebase test android run \
            --type instrumentation \
            --app app/build/outputs/apk/debug/app-debug.apk \
            --test app/build/outputs/apk/androidTest/debug/app-debug-androidTest.apk \
            --device model=Pixel6,version=33,locale=en,orientation=portrait \
            --timeout 15m \
            --results-bucket=${{ secrets.GCP_PROJECT_ID }}-test-lab-results

      # 8. (Optional) Always print link to results
      - name: Firebase Test Lab results info
        if: always()
        run: |
          echo "View test results in the Firebase Console:"
          echo "https://console.firebase.google.com/project/${{ secrets.GCP_PROJECT_ID }}/testlab"
